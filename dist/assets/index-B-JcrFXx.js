(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function S(e,{getStories:a,archiveStory:t,getArchivedStories:n,storyListView:i}){e.innerHTML="<p>Memuat cerita...</p>",(async()=>{try{let o=await a();const r=n();o=o.filter(s=>!r.includes(s.id)),e.innerHTML="",e.appendChild(i(o,{onArchive:async s=>{t(s),S(e,{getStories:a,archiveStory:t,getArchivedStories:n,storyListView:i})}}))}catch{e.innerHTML="<p>Gagal memuat cerita.</p>"}})()}function M(e,{addStory:a,addStoryView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),window.Notification&&Notification.permission==="granted"&&new Notification("Cerita baru berhasil disimpan!",{body:"Cerita Anda sudah masuk ke daftar.",icon:"/icons/icon-192.png"}),location.hash="/stories"}catch(i){i.message&&i.message.toLowerCase().includes("unauthorized")?(alert("Sesi login Anda habis atau tidak valid. Silakan login ulang."),location.hash="/login"):alert("Gagal menambah cerita. "+(i.message||""))}}}))}function C(e,{login:a,loginView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),alert("Login berhasil!"),location.hash="/stories"}catch(i){alert("Login gagal: "+i.message)}}}))}function A(e,{register:a,registerView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),alert("Registrasi berhasil! Silakan login."),location.hash="/login"}catch(i){alert("Registrasi gagal: "+i.message)}}}))}const O="cerita-app-db",g="stories";function h(){return new Promise((e,a)=>{const t=indexedDB.open(O,1);t.onupgradeneeded=()=>{t.result.createObjectStore(g,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})}async function q(e){const t=(await h()).transaction(g,"readwrite");return t.objectStore(g).put(e),t.complete||t.done||new Promise(n=>t.oncomplete=n)}async function D(){const a=(await h()).transaction(g,"readonly");return new Promise((t,n)=>{const i=a.objectStore(g).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async function B(e){const t=(await h()).transaction(g,"readwrite");return t.objectStore(g).delete(e),t.complete||t.done||new Promise(n=>t.oncomplete=n)}function T(e,{onArchive:a,offline:t,onDelete:n}={}){const i=document.createElement("section");return i.className="story-list",i.setAttribute("aria-label","Daftar Cerita"),e.forEach(o=>{const r=document.createElement("article");r.className="story-card",r.innerHTML=`
      <img src="${o.photoUrl}" alt="Foto cerita oleh ${o.name||""}" loading="lazy">
      <h2><i class="fa-solid fa-user"></i> ${o.name||""}</h2>
      <p>${o.description}</p>
      <p><i class="fa-solid fa-calendar"></i> <strong>Tanggal:</strong> ${o.createdAt?new Date(o.createdAt).toLocaleString():""}</p>
      <div><i class="fa-solid fa-map-marker-alt"></i> Lokasi:</div>
      <div class="story-map" id="map-${o.id}" style="height:220px;"></div>
      ${a?'<button class="archive-btn" aria-label="Arsipkan cerita" style="margin-top:8px"><i class="fa-solid fa-box-archive"></i> Arsipkan</button>':""}
      ${t?'<button class="delete-btn" aria-label="Hapus cerita offline" style="margin-top:8px"><i class="fa-solid fa-trash"></i> Hapus</button>':'<button class="save-btn" aria-label="Simpan offline" style="margin-top:8px"><i class="fa-solid fa-download"></i> Simpan Offline</button>'}
    `,i.appendChild(r),setTimeout(()=>I(`map-${o.id}`,o.lat,o.lon,o.name,o.description),0),a&&(r.querySelector(".archive-btn").onclick=()=>{confirm("Arsipkan cerita ini? Cerita akan disembunyikan dari daftar.")&&a(o.id)}),t&&n&&(r.querySelector(".delete-btn").onclick=()=>n(o.id)),!t&&window.saveStory&&(r.querySelector(".save-btn").onclick=()=>window.saveStory(o))}),i}function I(e,a,t,n,i){if(!a||!t)return;const o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),r=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),s=L.map(e,{zoomControl:!1,attributionControl:!1,layers:[o]}).setView([a,t],13),d={OpenStreetMap:o,MapTiler:r};L.control.layers(d).addTo(s),L.marker([a,t]).addTo(s).bindPopup(`<b>${n}</b><br>${i}`),setTimeout(()=>s.invalidateSize(),200)}function P(e){e.innerHTML="<p>Memuat cerita tersimpan...</p>",(async()=>{const a=await D();if(e.innerHTML="",!a.length){e.innerHTML="<p>Tidak ada cerita tersimpan offline.</p>";return}e.appendChild(T(a,{onDelete:async t=>{confirm("Hapus cerita ini dari penyimpanan offline?")&&(await B(t),P(e))},offline:!0}))})()}const E="https://story-api.dicoding.dev/v1/stories",N="https://story-api.dicoding.dev/v1/login",H="https://story-api.dicoding.dev/v1/register";function x(){return localStorage.getItem("token")||""}async function j(){const e=await fetch(E,{headers:{Authorization:`Bearer ${x()}`}});if(!e.ok)throw new Error("Gagal fetch");return(await e.json()).listStory}async function R({description:e,photo:a,lat:t,lon:n}){const i=new FormData;i.append("description",e),i.append("photo",a),i.append("lat",t),i.append("lon",n);const o=await fetch(E,{method:"POST",headers:{Authorization:`Bearer ${x()}`},body:i});if(!o.ok)throw new Error("Gagal tambah cerita");return o.json()}async function _({email:e,password:a}){const t=await fetch(N,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})}),n=await t.json();if(!t.ok)throw new Error(n.message||"Login gagal");return localStorage.setItem("token",n.loginResult.token),n.loginResult.token}async function U({name:e,email:a,password:t}){const n=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:a,password:t})}),i=await n.json();if(!n.ok)throw new Error(i.message||"Registrasi gagal");return i}async function $(e){const a=JSON.parse(localStorage.getItem("archivedStories")||"[]");a.includes(e)||(a.push(e),localStorage.setItem("archivedStories",JSON.stringify(a)))}function W(){return JSON.parse(localStorage.getItem("archivedStories")||"[]")}function z({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2><i class="fa-solid fa-plus"></i> Tambah Cerita Baru</h2>
    <form id="add-story-form" autocomplete="off">
      <label for="description">Deskripsi</label>
      <textarea id="description" required aria-label="Deskripsi cerita"></textarea>
      <label for="photo">Foto (kamera)</label>
      <input type="file" id="photo" accept="image/*" capture="environment" style="display:none" aria-label="Foto cerita">
      <button type="button" id="camera-btn" style="margin-bottom:8px"><i class="fa-solid fa-camera"></i> Ambil Foto dari Kamera</button>
      <button type="button" id="start-camera" style="margin-bottom:8px"><i class="fa-solid fa-video"></i> Aktifkan Kamera</button>
      <video id="camera-preview" autoplay playsinline style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;"></video>
      <button type="button" id="capture-btn" style="display:none;margin-bottom:8px"><i class="fa-solid fa-circle-dot"></i> Ambil Foto</button>
      <img id="photo-preview" alt="Preview foto cerita" style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;" />
      <label for="map">Pilih Lokasi</label>
      <div id="add-map" style="height:220px;"></div>
      <input type="hidden" id="lat" required>
      <input type="hidden" id="lon" required>
      <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim Cerita</button>
    </form>
  `,setTimeout(()=>G(a),0);const t=a.querySelector("form"),n=t.querySelector("#photo"),i=t.querySelector("#camera-btn"),o=t.querySelector("#start-camera"),r=t.querySelector("#camera-preview"),s=t.querySelector("#capture-btn"),d=a.querySelector("#photo-preview");let u,p=null;return i.onclick=l=>{l.preventDefault(),n.click()},o.onclick=async l=>{if(l.preventDefault(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{u=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),r.srcObject=u,r.style.display="block",s.style.display="inline-block",o.style.display="none",d.style.display="none"}catch(c){alert("Tidak dapat mengakses kamera: "+c.message)}else alert("Browser tidak mendukung kamera langsung.")},s.onclick=l=>{l.preventDefault();const c=document.createElement("canvas");c.width=r.videoWidth,c.height=r.videoHeight,c.getContext("2d").drawImage(r,0,0,c.width,c.height),c.toBlob(m=>{p=new File([m],"photo.jpg",{type:"image/jpeg"}),d.src=URL.createObjectURL(m),d.style.display="block"},"image/jpeg"),u&&(u.getTracks().forEach(m=>m.stop()),r.style.display="none",s.style.display="none",o.style.display="inline-block")},n.onchange=()=>{const l=n.files[0];if(l){p=l;const c=new FileReader;c.onload=f=>{d.src=f.target.result,d.style.display="block"},c.readAsDataURL(l)}else d.style.display="none",d.src="",p=null},t.onsubmit=l=>{l.preventDefault();const c=t.description.value,f=p,m=t.lat.value,b=t.lon.value;if(!m||!b)return alert("Pilih lokasi di peta!");if(!f)return alert("Ambil atau pilih foto terlebih dahulu!");e({description:c,photo:f,lat:m,lon:b})},a}function G(e){const a=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),t=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),n=L.map(e.querySelector("#add-map"),{zoomControl:!1,attributionControl:!1,layers:[a]}).setView([-6.2,106.8],10),i={OpenStreetMap:a,MapTiler:t};L.control.layers(i).addTo(n);let o;n.on("click",function(r){const{lat:s,lng:d}=r.latlng;e.querySelector("#lat").value=s,e.querySelector("#lon").value=d,o?o.setLatLng([s,d]):o=L.marker([s,d]).addTo(n),o.bindPopup("Lokasi cerita di sini").openPopup()})}function V({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Login</h2>
    <form id="login-form" autocomplete="off">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Login</button>
      <p>Belum punya akun? <a href="#/register">Register</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=n=>{n.preventDefault();const i=t.email.value,o=t.password.value;e({email:i,password:o})},a}function F({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Register</h2>
    <form id="register-form" autocomplete="off">
      <label for="name">Nama</label>
      <input type="text" id="name" required aria-label="Nama">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Register</button>
      <p>Sudah punya akun? <a href="#/login">Login</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=n=>{n.preventDefault();const i=t.name.value,o=t.email.value,r=t.password.value;e({name:i,email:o,password:r})},a}function K(){const e=document.createElement("section");return e.innerHTML=`
    <h2 style="color:#e57373"><i class="fa-solid fa-triangle-exclamation"></i> Halaman Tidak Ditemukan</h2>
    <p>Maaf, halaman yang Anda tuju tidak tersedia.</p>
    <a href="#/stories" style="color:#1976d2;font-weight:bold">Kembali ke Beranda</a>
  `,e}const J={"/stories":e=>S(e,{getStories:j,archiveStory:$,getArchivedStories:W,storyListView:T}),"/add":e=>M(e,{addStory:R,addStoryView:z}),"/login":e=>C(e,{login:_,loginView:V}),"/register":e=>A(e,{register:U,registerView:F}),"/saved":e=>P(e)};function Y(){window.addEventListener("hashchange",w),w()}function w(){const e=location.hash.replace("#","")||"/stories",a=document.getElementById("main-content");document.startViewTransition?document.startViewTransition(()=>v(e,a)):(a.animate([{opacity:1},{opacity:0}],{duration:150}),setTimeout(()=>{v(e,a),a.animate([{opacity:0},{opacity:1}],{duration:200})},150))}function v(e,a){const t=J[e];t?t(a):(a.innerHTML="",a.appendChild(K()))}const Z="modulepreload",Q=function(e){return"/"+e},k={},X=function(a,t,n){let i=Promise.resolve();if(t&&t.length>0){let r=function(u){return Promise.all(u.map(p=>Promise.resolve(p).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),d=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=r(t.map(u=>{if(u=Q(u),u in k)return;k[u]=!0;const p=u.endsWith(".css"),l=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${l}`))return;const c=document.createElement("link");if(c.rel=p?"stylesheet":Z,p||(c.as="script"),c.crossOrigin="",c.href=u,d&&c.setAttribute("nonce",d),document.head.appendChild(c),p)return new Promise((f,m)=>{c.addEventListener("load",f),c.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return i.then(r=>{for(const s of r||[])s.status==="rejected"&&o(s.reason);return a().catch(o)})};function ee(e={}){const{immediate:a=!1,onNeedRefresh:t,onOfflineReady:n,onRegistered:i,onRegisteredSW:o,onRegisterError:r}=e;let s,d;const u=async(l=!0)=>{await d};async function p(){if("serviceWorker"in navigator){if(s=await X(async()=>{const{Workbox:l}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:l}},[]).then(({Workbox:l})=>new l("/sw-push.js",{scope:"/",type:"classic"})).catch(l=>{r==null||r(l)}),!s)return;s.addEventListener("activated",l=>{(l.isUpdate||l.isExternal)&&window.location.reload()}),s.addEventListener("installed",l=>{l.isUpdate||n==null||n()}),s.register({immediate:a}).then(l=>{o?o("/sw-push.js",l):i==null||i(l)}).catch(l=>{r==null||r(l)})}}return d=p(),u}const te="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";async function ae(e,a){if(!("serviceWorker"in navigator)){alert("Service Worker tidak didukung di browser ini.");return}console.log("Token yang dikirim ke subscribe:",e);const t=await navigator.serviceWorker.ready;let n=await t.pushManager.getSubscription();if(!n)try{n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:oe(te)})}catch(i){alert("Gagal subscribe push notification: "+i.message);return}try{const i=n.toJSON();delete i.expirationTime;const o=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(!o.ok)if(o.status===401){alert("Token tidak valid atau sudah kadaluarsa. Silakan login ulang."),localStorage.removeItem("token"),location.reload();return}else{const r=await o.text();alert("Gagal mengirim subscription ke API Dicoding: "+r);return}alert("Push notification berhasil diaktifkan!"),a&&y(a)}catch(i){alert("Gagal mengirim subscription ke API Dicoding: "+i.message)}}async function ie(e){if(!("serviceWorker"in navigator))return;const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();t&&(await t.unsubscribe(),alert("Push notification dinonaktifkan!"),e&&y(e))}function oe(e){const a="=".repeat((4-e.length%4)%4),t=(e+a).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),i=new Uint8Array(n.length);for(let o=0;o<n.length;++o)i[o]=n.charCodeAt(o);return i}window.addEventListener("DOMContentLoaded",()=>{Y();const e=document.querySelector("nav ul");if(e){const t=localStorage.getItem("token"),n=e.querySelector('li:has(a[href="#/login"])'),i=e.querySelector('li:has(a[href="#/register"])');let o=e.querySelector("li.logout-li");if(t){if(n&&(n.style.display="none"),i&&(i.style.display="none"),!o){o=document.createElement("li"),o.className="logout-li";const r=document.createElement("button");r.innerHTML='<i class="fa-solid fa-right-from-bracket"></i> Logout',r.onclick=()=>{localStorage.removeItem("token"),location.reload()},o.appendChild(r),e.appendChild(o)}}else n&&(n.style.display=""),i&&(i.style.display=""),o&&o.remove()}const a=document.getElementById("enable-push");a&&(y(a),a.onclick=()=>{const t=localStorage.getItem("token");if(!t){alert("Silakan login terlebih dahulu untuk mengaktifkan push notification.");return}a.dataset.active==="true"?ie(a):ae(t,a)})});async function y(e){if(!("serviceWorker"in navigator))return;await(await navigator.serviceWorker.ready).pushManager.getSubscription()?(e.textContent="🔕 Nonaktifkan Notifikasi",e.dataset.active="true",e.classList.add("active")):(e.textContent="🔔 Aktifkan Notifikasi",e.dataset.active="false",e.classList.remove("active"))}window.saveStory=async e=>{await q(e),alert("Cerita disimpan untuk offline!")};"serviceWorker"in navigator&&window.addEventListener("load",()=>{ee({immediate:!0})});
