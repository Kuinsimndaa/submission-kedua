(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();function S(e,{getStories:i,archiveStory:t,getArchivedStories:o,storyListView:a}){e.innerHTML="<p>Memuat cerita...</p>",(async()=>{try{let n=await i();const r=o();n=n.filter(s=>!r.includes(s.id)),e.innerHTML="",e.appendChild(a(n,{onArchive:async s=>{t(s),S(e,{getStories:i,archiveStory:t,getArchivedStories:o,storyListView:a})}}))}catch{e.innerHTML="<p>Gagal memuat cerita.</p>"}})()}function M(e,{addStory:i,addStoryView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async o=>{try{await i(o),window.Notification&&Notification.permission==="granted"&&new Notification("Cerita baru berhasil disimpan!",{body:"Cerita Anda sudah masuk ke daftar.",icon:"/icons/icon-192.png"}),location.hash="/stories"}catch(a){a.message&&a.message.toLowerCase().includes("unauthorized")?(alert("Sesi login Anda habis atau tidak valid. Silakan login ulang."),location.hash="/login"):alert("Gagal menambah cerita. "+(a.message||""))}}}))}function C(e,{login:i,loginView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async o=>{try{await i(o),alert("Login berhasil!");const a=document.querySelector(".skip-link");a&&(a.style.display="inline-block"),location.hash="/stories"}catch(a){alert("Login gagal: "+a.message)}}}))}function A(e,{register:i,registerView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async o=>{try{await i(o),alert("Registrasi berhasil! Silakan login."),location.hash="/login"}catch(a){alert("Registrasi gagal: "+a.message)}}}))}const q="cerita-app-db",g="stories";function h(){return new Promise((e,i)=>{const t=indexedDB.open(q,1);t.onupgradeneeded=()=>{t.result.createObjectStore(g,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>i(t.error)})}async function O(e){const t=(await h()).transaction(g,"readwrite");return t.objectStore(g).put(e),t.complete||t.done||new Promise(o=>t.oncomplete=o)}async function D(){const i=(await h()).transaction(g,"readonly");return new Promise((t,o)=>{const a=i.objectStore(g).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)})}async function I(e){const t=(await h()).transaction(g,"readwrite");return t.objectStore(g).delete(e),t.complete||t.done||new Promise(o=>t.oncomplete=o)}function T(e,{onArchive:i,offline:t,onDelete:o}={}){const a=document.createElement("section");return a.className="story-list",a.setAttribute("aria-label","Daftar Cerita"),e.forEach(n=>{const r=document.createElement("article");r.className="story-card",r.innerHTML=`
      <img src="${n.photoUrl}" alt="Foto cerita oleh ${n.name||""}" loading="lazy">
      <h2><i class="fa-solid fa-user"></i> ${n.name||""}</h2>
      <p>${n.description}</p>
      <p><i class="fa-solid fa-calendar"></i> <strong>Tanggal:</strong> ${n.createdAt?new Date(n.createdAt).toLocaleString():""}</p>
      <div><i class="fa-solid fa-map-marker-alt"></i> Lokasi:</div>
      <div class="story-map" id="map-${n.id}" style="height:220px;"></div>
      ${i?'<button class="archive-btn" aria-label="Arsipkan cerita" style="margin-top:8px"><i class="fa-solid fa-box-archive"></i> Arsipkan</button>':""}
      ${t?'<button class="delete-btn" aria-label="Hapus cerita offline" style="margin-top:8px"><i class="fa-solid fa-trash"></i> Hapus</button>':'<button class="save-btn" aria-label="Simpan offline" style="margin-top:8px"><i class="fa-solid fa-download"></i> Simpan Offline</button>'}
    `,a.appendChild(r),setTimeout(()=>B(`map-${n.id}`,n.lat,n.lon,n.name,n.description),0),i&&(r.querySelector(".archive-btn").onclick=()=>{confirm("Arsipkan cerita ini? Cerita akan disembunyikan dari daftar.")&&i(n.id)}),t&&o&&(r.querySelector(".delete-btn").onclick=()=>o(n.id)),!t&&window.saveStory&&(r.querySelector(".save-btn").onclick=()=>window.saveStory(n))}),a}function B(e,i,t,o,a){if(!i||!t)return;const n=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),r=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),s=L.map(e,{zoomControl:!1,attributionControl:!1,layers:[n]}).setView([i,t],13),c={OpenStreetMap:n,MapTiler:r};L.control.layers(c).addTo(s),L.marker([i,t]).addTo(s).bindPopup(`<b>${o}</b><br>${a}`),setTimeout(()=>s.invalidateSize(),200)}function P(e){e.innerHTML="<p>Memuat cerita tersimpan...</p>",(async()=>{const i=await D();if(e.innerHTML="",!i.length){e.innerHTML="<p>Tidak ada cerita tersimpan offline.</p>";return}e.appendChild(T(i,{onDelete:async t=>{confirm("Hapus cerita ini dari penyimpanan offline?")&&(await I(t),P(e))},offline:!0}))})()}const E="https://story-api.dicoding.dev/v1/stories",N="https://story-api.dicoding.dev/v1/login",H="https://story-api.dicoding.dev/v1/register";function x(){return localStorage.getItem("token")||""}async function j(){const e=await fetch(E,{headers:{Authorization:`Bearer ${x()}`}});if(!e.ok)throw new Error("Gagal fetch");return(await e.json()).listStory}async function R({description:e,photo:i,lat:t,lon:o}){const a=new FormData;a.append("description",e),a.append("photo",i),a.append("lat",t),a.append("lon",o);const n=await fetch(E,{method:"POST",headers:{Authorization:`Bearer ${x()}`},body:a});if(!n.ok)throw new Error("Gagal tambah cerita");return n.json()}async function _({email:e,password:i}){const t=await fetch(N,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:i})}),o=await t.json();if(!t.ok)throw new Error(o.message||"Login gagal");return localStorage.setItem("token",o.loginResult.token),o.loginResult.token}async function U({name:e,email:i,password:t}){const o=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:i,password:t})}),a=await o.json();if(!o.ok)throw new Error(a.message||"Registrasi gagal");return a}async function $(e){const i=JSON.parse(localStorage.getItem("archivedStories")||"[]");i.includes(e)||(i.push(e),localStorage.setItem("archivedStories",JSON.stringify(i)))}function W(){return JSON.parse(localStorage.getItem("archivedStories")||"[]")}function z({onSubmit:e}){const i=document.createElement("section");i.innerHTML=`
    <h2><i class="fa-solid fa-plus"></i> Tambah Cerita Baru</h2>
    <form id="add-story-form" autocomplete="off">
      <label for="description">Deskripsi</label>
      <textarea id="description" required aria-label="Deskripsi cerita"></textarea>
      <label for="photo">Foto (kamera)</label>
      <input type="file" id="photo" accept="image/*" capture="environment" style="display:none" aria-label="Foto cerita">
      <button type="button" id="camera-btn" style="margin-bottom:8px"><i class="fa-solid fa-camera"></i> Ambil Foto dari Kamera</button>
      <button type="button" id="start-camera" style="margin-bottom:8px"><i class="fa-solid fa-video"></i> Aktifkan Kamera</button>
      <video id="camera-preview" autoplay playsinline style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;"></video>
      <button type="button" id="capture-btn" style="display:none;margin-bottom:8px"><i class="fa-solid fa-circle-dot"></i> Ambil Foto</button>
      <img id="photo-preview" alt="Preview foto cerita" style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;" />
      <label for="map">Pilih Lokasi</label>
      <div id="add-map" style="height:220px;"></div>
      <input type="hidden" id="lat" required>
      <input type="hidden" id="lon" required>
      <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim Cerita</button>
    </form>
  `,setTimeout(()=>V(i),0);const t=i.querySelector("form"),o=t.querySelector("#photo"),a=t.querySelector("#camera-btn"),n=t.querySelector("#start-camera"),r=t.querySelector("#camera-preview"),s=t.querySelector("#capture-btn"),c=i.querySelector("#photo-preview");let u,p=null;return a.onclick=l=>{l.preventDefault(),o.click()},n.onclick=async l=>{if(l.preventDefault(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{u=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),r.srcObject=u,r.style.display="block",s.style.display="inline-block",n.style.display="none",c.style.display="none"}catch(d){alert("Tidak dapat mengakses kamera: "+d.message)}else alert("Browser tidak mendukung kamera langsung.")},s.onclick=l=>{l.preventDefault();const d=document.createElement("canvas");d.width=r.videoWidth,d.height=r.videoHeight,d.getContext("2d").drawImage(r,0,0,d.width,d.height),d.toBlob(m=>{p=new File([m],"photo.jpg",{type:"image/jpeg"}),c.src=URL.createObjectURL(m),c.style.display="block"},"image/jpeg"),u&&(u.getTracks().forEach(m=>m.stop()),r.style.display="none",s.style.display="none",n.style.display="inline-block")},o.onchange=()=>{const l=o.files[0];if(l){p=l;const d=new FileReader;d.onload=f=>{c.src=f.target.result,c.style.display="block"},d.readAsDataURL(l)}else c.style.display="none",c.src="",p=null},t.onsubmit=l=>{l.preventDefault();const d=t.description.value,f=p,m=t.lat.value,b=t.lon.value;if(!m||!b)return alert("Pilih lokasi di peta!");if(!f)return alert("Ambil atau pilih foto terlebih dahulu!");e({description:d,photo:f,lat:m,lon:b})},i}function V(e){const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),t=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),o=L.map(e.querySelector("#add-map"),{zoomControl:!1,attributionControl:!1,layers:[i]}).setView([-6.2,106.8],10),a={OpenStreetMap:i,MapTiler:t};L.control.layers(a).addTo(o);let n;o.on("click",function(r){const{lat:s,lng:c}=r.latlng;e.querySelector("#lat").value=s,e.querySelector("#lon").value=c,n?n.setLatLng([s,c]):n=L.marker([s,c]).addTo(o),n.bindPopup("Lokasi cerita di sini").openPopup()})}function G({onSubmit:e}){const i=document.createElement("section");i.innerHTML=`
    <h2>Login</h2>
    <form id="login-form" autocomplete="off">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Login</button>
      <p>Belum punya akun? <a href="#/register">Register</a></p>
    </form>
  `;const t=i.querySelector("form");return t.onsubmit=o=>{o.preventDefault();const a=t.email.value,n=t.password.value;e({email:a,password:n})},i}function F({onSubmit:e}){const i=document.createElement("section");i.innerHTML=`
    <h2>Register</h2>
    <form id="register-form" autocomplete="off">
      <label for="name">Nama</label>
      <input type="text" id="name" required aria-label="Nama">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Register</button>
      <p>Sudah punya akun? <a href="#/login">Login</a></p>
    </form>
  `;const t=i.querySelector("form");return t.onsubmit=o=>{o.preventDefault();const a=t.name.value,n=t.email.value,r=t.password.value;e({name:a,email:n,password:r})},i}function K(){const e=document.createElement("section");return e.innerHTML=`
    <h2 style="color:#e57373"><i class="fa-solid fa-triangle-exclamation"></i> Halaman Tidak Ditemukan</h2>
    <p>Maaf, halaman yang Anda tuju tidak tersedia.</p>
    <a href="#/stories" style="color:#1976d2;font-weight:bold">Kembali ke Beranda</a>
  `,e}const J={"/stories":e=>S(e,{getStories:j,archiveStory:$,getArchivedStories:W,storyListView:T}),"/add":e=>M(e,{addStory:R,addStoryView:z}),"/login":e=>C(e,{login:_,loginView:G}),"/register":e=>A(e,{register:U,registerView:F}),"/saved":e=>P(e)};function Y(){window.addEventListener("hashchange",w),w()}function w(){const e=location.hash.replace("#","")||"/stories",i=document.getElementById("main-content");document.startViewTransition?document.startViewTransition(()=>v(e,i)):(i.animate([{opacity:1},{opacity:0}],{duration:150}),setTimeout(()=>{v(e,i),i.animate([{opacity:0},{opacity:1}],{duration:200})},150))}function v(e,i){const t=J[e];t?t(i):(i.innerHTML="",i.appendChild(K()))}const Z="modulepreload",Q=function(e){return"/"+e},k={},X=function(i,t,o){let a=Promise.resolve();if(t&&t.length>0){let r=function(u){return Promise.all(u.map(p=>Promise.resolve(p).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=r(t.map(u=>{if(u=Q(u),u in k)return;k[u]=!0;const p=u.endsWith(".css"),l=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${l}`))return;const d=document.createElement("link");if(d.rel=p?"stylesheet":Z,p||(d.as="script"),d.crossOrigin="",d.href=u,c&&d.setAttribute("nonce",c),document.head.appendChild(d),p)return new Promise((f,m)=>{d.addEventListener("load",f),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${u}`)))})}))}function n(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return a.then(r=>{for(const s of r||[])s.status==="rejected"&&n(s.reason);return i().catch(n)})};function ee(e={}){const{immediate:i=!1,onNeedRefresh:t,onOfflineReady:o,onRegistered:a,onRegisteredSW:n,onRegisterError:r}=e;let s,c;const u=async(l=!0)=>{await c};async function p(){if("serviceWorker"in navigator){if(s=await X(async()=>{const{Workbox:l}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:l}},[]).then(({Workbox:l})=>new l("/sw-push.js",{scope:"/",type:"classic"})).catch(l=>{r==null||r(l)}),!s)return;s.addEventListener("activated",l=>{(l.isUpdate||l.isExternal)&&window.location.reload()}),s.addEventListener("installed",l=>{l.isUpdate||o==null||o()}),s.register({immediate:i}).then(l=>{n?n("/sw-push.js",l):a==null||a(l)}).catch(l=>{r==null||r(l)})}}return c=p(),u}const te="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";async function ae(e,i){if(!("serviceWorker"in navigator)){alert("Service Worker tidak didukung di browser ini.");return}console.log("Token yang dikirim ke subscribe:",e);const t=await navigator.serviceWorker.ready;let o=await t.pushManager.getSubscription();if(!o)try{o=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ne(te)})}catch(a){alert("Gagal subscribe push notification: "+a.message);return}try{const a=o.toJSON();delete a.expirationTime;const n=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)if(n.status===401){alert("Token tidak valid atau sudah kadaluarsa. Silakan login ulang."),localStorage.removeItem("token"),location.reload();return}else{const r=await n.text();alert("Gagal mengirim subscription ke API Dicoding: "+r);return}alert("Push notification berhasil diaktifkan!"),i&&y(i)}catch(a){alert("Gagal mengirim subscription ke API Dicoding: "+a.message)}}async function ie(e){if(!("serviceWorker"in navigator))return;const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();t&&(await t.unsubscribe(),alert("Push notification dinonaktifkan!"),e&&y(e))}function ne(e){const i="=".repeat((4-e.length%4)%4),t=(e+i).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(t),a=new Uint8Array(o.length);for(let n=0;n<o.length;++n)a[n]=o.charCodeAt(n);return a}window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#main-content"),i=document.querySelector(".skip-link");e&&i&&i.addEventListener("click",function(a){a.preventDefault(),i.blur(),e.focus(),e.scrollIntoView()}),Y();const t=document.querySelector("nav ul");if(t){const a=localStorage.getItem("token"),n=t.querySelector('li:has(a[href="#/login"])'),r=t.querySelector('li:has(a[href="#/register"])');let s=t.querySelector("li.logout-li");if(a){if(n&&(n.style.display="none"),r&&(r.style.display="none"),!s){s=document.createElement("li"),s.className="logout-li";const c=document.createElement("button");c.innerHTML='<i class="fa-solid fa-right-from-bracket"></i> Logout',c.onclick=()=>{localStorage.removeItem("token"),location.reload()},s.appendChild(c),t.appendChild(s)}}else n&&(n.style.display=""),r&&(r.style.display=""),s&&s.remove()}const o=document.getElementById("enable-push");o&&(y(o),o.onclick=()=>{const a=localStorage.getItem("token");if(!a){alert("Silakan login terlebih dahulu untuk mengaktifkan push notification.");return}o.dataset.active==="true"?ie(o):ae(a,o)})});async function y(e){if(!("serviceWorker"in navigator))return;await(await navigator.serviceWorker.ready).pushManager.getSubscription()?(e.textContent="🔕 Nonaktifkan Notifikasi",e.dataset.active="true",e.classList.add("active")):(e.textContent="🔔 Aktifkan Notifikasi",e.dataset.active="false",e.classList.remove("active"))}window.saveStory=async e=>{await O(e),alert("Cerita disimpan untuk offline!")};"serviceWorker"in navigator&&window.addEventListener("load",()=>{ee({immediate:!0})});
